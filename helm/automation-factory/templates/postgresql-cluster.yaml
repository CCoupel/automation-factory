{{- if and (index .Values "cloudnative-pg" "enabled") .Values.postgresql.enabled }}
apiVersion: postgresql.cnpg.io/v1
kind: Cluster
metadata:
  name: {{ include "automation-factory.fullname" . }}-postgresql
  labels:
    {{- include "automation-factory.labels" . | nindent 4 }}
    app.kubernetes.io/component: database
spec:
  instances: {{ .Values.postgresql.instances }}

  # PostgreSQL configuration
  postgresql:
    parameters:
      max_connections: "200"
      shared_buffers: "256MB"

  # Bootstrap configuration
  bootstrap:
    initdb:
      database: {{ .Values.postgresql.auth.database }}
      owner: {{ .Values.postgresql.auth.username }}
      secret:
        name: {{ include "automation-factory.fullname" . }}-postgresql-credentials

  # Storage configuration
  storage:
    size: {{ .Values.postgresql.storage.size }}
    {{- if .Values.postgresql.storage.storageClass }}
    storageClass: {{ .Values.postgresql.storage.storageClass }}
    {{- else if .Values.global.storageClass }}
    storageClass: {{ .Values.global.storageClass }}
    {{- end }}

  # Resource limits
  resources:
    limits:
      cpu: {{ .Values.postgresql.resources.limits.cpu }}
      memory: {{ .Values.postgresql.resources.limits.memory }}
    requests:
      cpu: {{ .Values.postgresql.resources.requests.cpu }}
      memory: {{ .Values.postgresql.resources.requests.memory }}

  # Backup configuration (optional - can be enabled later)
  # backup:
  #   barmanObjectStore:
  #     destinationPath: s3://backups/
  #     s3Credentials:
  #       accessKeyId:
  #         name: aws-creds
  #         key: ACCESS_KEY_ID
  #       secretAccessKey:
  #         name: aws-creds
  #         key: ACCESS_SECRET_KEY

  # Monitoring (Prometheus)
  monitoring:
    enablePodMonitor: false

---
apiVersion: v1
kind: Secret
metadata:
  name: {{ include "automation-factory.fullname" . }}-postgresql-credentials
  labels:
    {{- include "automation-factory.labels" . | nindent 4 }}
    app.kubernetes.io/component: database
type: kubernetes.io/basic-auth
stringData:
  username: {{ .Values.postgresql.auth.username }}
  password: {{ .Values.postgresql.auth.password }}
{{- end }}
