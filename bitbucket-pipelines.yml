image: atlassian/default-image:3

definitions:
  services:
    docker:
      memory: 6128

  steps:
    - step: &build-backend
        name: Build and Push Backend Docker Image
        services:
          - docker
        script:
          - echo "ðŸ³ Building Backend Docker Image"
          - cd helm/ansible-builder
          - export IMAGE_VERSION=$(grep '^version:' Chart.yaml | awk '{print $2}')
          - export APP_VERSION=$(grep '^appVersion:' Chart.yaml | awk '{print $2}' | tr -d '"')
          - echo "Image version $IMAGE_VERSION (app $APP_VERSION)"
          - cd ../../backend
          - echo "ðŸ” Logging in to GitHub Container Registry..."
          - echo "$GITHUB_TOKEN" | docker login ghcr.io -u "$GITHUB_USERNAME" --password-stdin
          - echo "ðŸ—ï¸  Building backend image..."
          - docker build -t "ghcr.io/$GITHUB_USERNAME/ansible-builder-backend:$IMAGE_VERSION" .
          - docker tag "ghcr.io/$GITHUB_USERNAME/ansible-builder-backend:$IMAGE_VERSION" "ghcr.io/$GITHUB_USERNAME/ansible-builder-backend:latest"
          - echo "ðŸš€ Pushing backend image..."
          - docker push "ghcr.io/$GITHUB_USERNAME/ansible-builder-backend:$IMAGE_VERSION"
          - docker push "ghcr.io/$GITHUB_USERNAME/ansible-builder-backend:latest"
          - echo "âœ… Backend image published!"
          - echo "ðŸ“ ghcr.io/$GITHUB_USERNAME/ansible-builder-backend:$IMAGE_VERSION"

    - step: &build-frontend
        name: Build and Push Frontend Docker Image
        services:
          - docker
        script:
          - echo "ðŸ³ Building Frontend Docker Image"
          - cd helm/ansible-builder
          - export IMAGE_VERSION=$(grep '^version:' Chart.yaml | awk '{print $2}')
          - export APP_VERSION=$(grep '^appVersion:' Chart.yaml | awk '{print $2}' | tr -d '"')
          - echo "Image version $IMAGE_VERSION (app $APP_VERSION)"
          - cd ../../frontend
          - echo "ðŸ” Logging in to GitHub Container Registry..."
          - echo "$GITHUB_TOKEN" | docker login ghcr.io -u "$GITHUB_USERNAME" --password-stdin
          - echo "ðŸ—ï¸  Building frontend image..."
          - docker build -t "ghcr.io/$GITHUB_USERNAME/ansible-builder-frontend:$IMAGE_VERSION" .
          - docker tag "ghcr.io/$GITHUB_USERNAME/ansible-builder-frontend:$IMAGE_VERSION" "ghcr.io/$GITHUB_USERNAME/ansible-builder-frontend:latest"
          - echo "ðŸš€ Pushing frontend image..."
          - docker push "ghcr.io/$GITHUB_USERNAME/ansible-builder-frontend:$IMAGE_VERSION"
          - docker push "ghcr.io/$GITHUB_USERNAME/ansible-builder-frontend:latest"
          - echo "âœ… Frontend image published!"
          - echo "ðŸ“ ghcr.io/$GITHUB_USERNAME/ansible-builder-frontend:$IMAGE_VERSION"

    - step: &publish-helm-chart
        name: Package and Push Helm Chart to GHCR
        image: alpine/helm:3.13.0
        script:
          - apk add --no-cache git findutils
          - echo "ðŸ“¦ Building Helm chart for Ansible Builder"
          - helm version
          - echo "ðŸ“¦ Adding Helm repositories..."
          - helm repo add pascaliske https://charts.pascaliske.dev
          - helm repo update
          - echo "ðŸ“¦ Searching available charts in repositories..."
          - helm search repo pascaliske
          - cd helm/ansible-builder
          - export CHART_VERSION=$(grep '^version:' Chart.yaml | awk '{print $2}')
          - echo "Chart version detected $CHART_VERSION"
          - echo "ðŸ“¦ Creating charts directory..."
          - mkdir -p charts
          - echo "ðŸ“¦ Updating Helm dependencies..."
          - helm dependency update
          - echo "ðŸ“¦ Checking downloaded dependencies..."
          - ls -lha charts/ || echo "charts/ directory not found"
          - cat Chart.lock || echo "Chart.lock not found"
          - echo "ðŸ“¦ Packaging Helm chart..."
          - helm package . --destination charts/
          - ls -lh charts/
          - echo "ðŸ” Logging in to GitHub Container Registry..."
          - echo "$GITHUB_USERNAME => $GITHUB_TOKEN"
          - echo "$GITHUB_TOKEN" | helm registry login ghcr.io -u "$GITHUB_USERNAME" --password-stdin
          - echo "ðŸš€ Pushing chart to ghcr.io/$GITHUB_USERNAME..."
          - helm push "charts/ansible-builder-${CHART_VERSION}.tgz" "oci://ghcr.io/$GITHUB_USERNAME"
          - echo "âœ… Chart published successfully!"
          - echo ""
          - echo "ðŸ“¦ PUBLISHED ARTIFACTS:"
          - echo "  - Helm Chart    oci://ghcr.io/$GITHUB_USERNAME/ansible-builder:$CHART_VERSION"
          - echo "  - Backend Image ghcr.io/$GITHUB_USERNAME/ansible-builder-backend:$CHART_VERSION"
          - echo "  - Frontend Image ghcr.io/$GITHUB_USERNAME/ansible-builder-frontend:$CHART_VERSION"
          - echo ""
          - echo "Install with:"
          - echo "  helm install ansible-builder oci://ghcr.io/$GITHUB_USERNAME/ansible-builder \\"
          - echo "    --version $CHART_VERSION \\"
          - echo "    --namespace ansible-builder \\"
          - echo "    --create-namespace"

pipelines:
  tags:
    'v*.*.*':
      - step: *build-backend
      - step: *build-frontend
      - step: *publish-helm-chart

  custom:
    publish-all:
      - step: *build-backend
      - step: *build-frontend
      - step: *publish-helm-chart

    publish-chart-only:
      - step: *publish-helm-chart
