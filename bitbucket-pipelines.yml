image: alpine/helm:3.13.0

definitions:
  steps:
    - step: &publish-helm-chart
        name: Package and Push Helm Chart to GHCR
        script:
          - apk add --no-cache git findutils
          - echo "üì¶ Building Helm chart for Ansible Builder"
          - helm version
          - echo "üì¶ Adding Helm repositories..."
          - helm repo add cloudnative-pg https://cloudnative-pg.github.io/charts
          - helm repo add pascaliske https://charts.pascaliske.dev
          - helm repo update
          - echo "üì¶ Searching available charts in repositories..."
          - helm search repo cloudnative-pg
          - helm search repo pascaliske
          - cd helm/ansible-builder
          - export CHART_VERSION=$(grep '^version:' Chart.yaml | awk '{print $2}')
          - echo "Chart version detected:$CHART_VERSION"
          - echo "üì¶ Creating charts directory..."
          - mkdir -p charts
          - echo "üì¶ Updating Helm dependencies..."
          - helm dependency update
          - echo "üì¶ Checking downloaded dependencies..."
          - ls -lha charts/ || echo "charts/ directory not found"
          - cat Chart.lock || echo "Chart.lock not found"
          - echo "üì¶ Packaging Helm chart..."
          - helm package . --destination charts/
          - ls -lh charts/
          - echo "üîê Logging in to GitHub Container Registry..."
          - echo "$GITHUB_USERNAME => $GITHUB_TOKEN"
          - echo "$GITHUB_TOKEN" | helm registry login ghcr.io -u "$GITHUB_USERNAME" --password-stdin
          - echo "üöÄ Pushing chart to ghcr.io/$GITHUB_USERNAME..."
          - helm push "charts/ansible-builder-${CHART_VERSION}.tgz" "oci://ghcr.io/$GITHUB_USERNAME"
          - echo "‚úÖ Chart published successfully!"
          - echo ""
          - echo "üìç Location oci://ghcr.io/$GITHUB_USERNAME/ansible-builder"
          - echo "üì¶ Version $CHART_VERSION"
          - echo ""
          - echo "Users can install with helm install ansible-builder oci://ghcr.io/$GITHUB_USERNAME/ansible-builder --version $CHART_VERSION"

pipelines:
  tags:
    'v*.*.*':
      - step: *publish-helm-chart

  custom:
    publish-chart:
      - step: *publish-helm-chart
