image: alpine/helm:3.13.0

definitions:
  steps:
    - step: &publish-helm-chart
        name: Package and Push Helm Chart to GHCR
        script:
          - apk add --no-cache git findutils
          - echo "ğŸ“¦ Building Helm chart for Ansible Builder"
          - helm version
          - cd helm/ansible-builder
          - export CHART_VERSION=$(grep '^version:' Chart.yaml | awk '{print $2}')
          - echo "Chart version detected:$CHART_VERSION"
          - echo "ğŸ“¦ Updating Helm dependencies..."
          - helm dependency update
          - echo "ğŸ“¦ Packaging Helm chart..."
          - helm package . --destination ../../charts/
          - ls -lh ../../charts/
          - echo "ğŸ” Logging in to GitHub Container Registry..."
          - echo "$GITHUB_TOKEN" | helm registry login ghcr.io -u "$GITHUB_USERNAME" --password-stdin
          - echo "ğŸš€ Pushing chart to ghcr.io/$GITHUB_USERNAME..."
          - helm push "../../charts/ansible-builder-${CHART_VERSION}.tgz" "oci://ghcr.io/$GITHUB_USERNAME"
          - echo "âœ… Chart published successfully!"
          - echo ""
          - echo "ğŸ“ Location oci://ghcr.io/$GITHUB_USERNAME/ansible-builder"
          - echo "ğŸ“¦ Version $CHART_VERSION"
          - echo ""
          - echo "Users can install with helm install ansible-builder oci://ghcr.io/$GITHUB_USERNAME/ansible-builder --version $CHART_VERSION"

pipelines:
  tags:
    'v*.*.*':
      - step: *publish-helm-chart

  custom:
    publish-chart:
      - step: *publish-helm-chart
