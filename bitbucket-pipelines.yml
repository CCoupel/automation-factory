image: alpine/helm:3.13.0

definitions:
  steps:
    - step: &publish-helm-chart
        name: Package and Push Helm Chart to GHCR
        caches:
          - docker
        script:
          # Installer les d√©pendances n√©cessaires
          - apk add --no-cache git findutils

          # Afficher les informations
          - echo "üì¶ Building Helm chart for Ansible Builder"
          - helm version

          # Obtenir la version depuis Chart.yaml
          - cd helm/ansible-builder
          - export CHART_VERSION=$(grep '^version:' Chart.yaml | awk '{print $2}')
          - echo "Chart version detected: $CHART_VERSION"

          # Mettre √† jour les d√©pendances Helm
          - echo "üì¶ Updating Helm dependencies..."
          - helm dependency update

          # Packager le chart
          - echo "üì¶ Packaging Helm chart..."
          - helm package . --destination ../../charts/
          - ls -lh ../../charts/

          # Se connecter √† GitHub Container Registry
          - echo "üîê Logging in to GitHub Container Registry..."
          - echo "$GITHUB_TOKEN" | helm registry login ghcr.io -u "$GITHUB_USERNAME" --password-stdin

          # Pousser le chart vers GHCR
          - echo "üöÄ Pushing chart to ghcr.io/$GITHUB_USERNAME..."
          - helm push "../../charts/ansible-builder-${CHART_VERSION}.tgz" "oci://ghcr.io/$GITHUB_USERNAME"

          # Afficher les instructions d'installation
          - echo "‚úÖ Chart published successfully!"
          - echo ""
          - echo "üìç Location: oci://ghcr.io/$GITHUB_USERNAME/ansible-builder"
          - echo "üì¶ Version: $CHART_VERSION"
          - echo ""
          - echo "Users can install with:"
          - echo "  helm install ansible-builder oci://ghcr.io/$GITHUB_USERNAME/ansible-builder --version $CHART_VERSION"

pipelines:
  # D√©clench√© automatiquement sur les tags version (v1.0.0, v1.1.0, etc.)
  tags:
    'v*.*.*':
      - step: *publish-helm-chart

  # D√©clench√© manuellement via l'interface Bitbucket (optionnel)
  custom:
    publish-chart:
      - step: *publish-helm-chart

  # Optionnel: d√©clench√© sur push vers master (comment√© par d√©faut)
  # branches:
  #   master:
  #     - step: *publish-helm-chart
